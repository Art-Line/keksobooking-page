(()=>{"use strict";const e=e=>{for(;e.firstChild;)e.removeChild(e.firstChild)},t=document.querySelector("main"),r=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error"),n=document.querySelector(".error__button"),a=(e,r)=>{const o=e.cloneNode(!0);o.style.zIndex=9999,t.appendChild(o);const a=e=>{(e=>"Escape"===e.key||"Esc"===e.key)(e)&&(e.preventDefault(),c())},s=()=>c(),c=()=>{o.classList.add("hidden"),r&&r.removeEventListener("click",s),o.removeEventListener("click",s),document.removeEventListener("keydown",a)};r&&n.addEventListener("click",s),o.addEventListener("click",s),document.addEventListener("keydown",a)},s="any",c=document.querySelector(".map__filters"),i=Array.from(c.children),l=document.querySelector("#housing-type"),d=document.querySelector("#housing-price"),u=document.querySelector("#housing-rooms"),p=document.querySelector("#housing-guests"),m=document.querySelector("#housing-features"),f={low:{min:0,max:1e4},middle:{min:1e4,max:5e4},high:{min:5e4,max:Number.MAX_SAFE_INTEGER}};c.classList.add("map__filters--disabled"),i.forEach((e=>{e.disabled=!0}));const y=e=>(e=>{if(e.offer.type===l.value||l.value===s)return e})(e)&&(e=>{if(e.offer.rooms===parseInt(u.value)||u.value===s)return e})(e)&&(e=>{if(e.offer.guests===parseInt(p.value)||p.value===s)return e})(e)&&(e=>d.value===s||e.offer.price>f[d.value].min&&e.offer.price<=f[d.value].max?e:void 0)(e)&&(e=>Array.from(m.querySelectorAll("input:checked")).every((t=>e.offer.features.includes(t.value))))(e),v={bungalow:"Бунгало",flat:"Квартира",house:"Дом",palace:"Дворец"},h=document.querySelector("#card").content.querySelector(".popup"),g=(e,t,r,o)=>{const n=e.querySelector(t);return r?n.textContent=o?r+o:r:e.removeChild(n)},S=35.6817,q=139.75388,b=e=>e/2,E=L.map("map-canvas"),x=()=>{U.value="35.6817, 139.75388"},C=(()=>{const e=L.icon({iconUrl:"./img/main-pin.svg",iconSize:[52,52],iconAnchor:[b(52),52]}),t=L.marker({lat:S,lng:q},{draggable:!0,icon:e});return t.addTo(E),t.on("moveend",(e=>{const t=e.target.getLatLng(),r=t.lat.toFixed(5),o=t.lng.toFixed(5);U.value=`${r}, ${o}`})),t})(),k=()=>{C.setLatLng([S,q]).update(),E.setView({lat:S,lng:q},9),E.closePopup()},w=L.layerGroup().addTo(E),A=t=>{c.classList.remove("map__filters--disabled"),i.forEach((e=>{e.disabled=!1}));const r=L.icon({iconUrl:"./img/pin.svg",iconSize:[40,40],iconAnchor:[b(40),40]});t.slice(0,10).forEach((t=>{L.marker({lat:t.location.lat,lng:t.location.lng},{icon:r}).addTo(w).bindPopup((t=>{const r=h.cloneNode(!0);return g(r,".popup__title",t.offer.title),g(r,".popup__text--address",t.offer.address),g(r,".popup__description",t.offer.description),g(r,".popup__text--price",t.offer.price," ₽/ночь"),((e,t,r)=>{const o=e.querySelector(".popup__avatar");r?o.src=r:e.removeChild(o)})(r,0,t.author.avatar),((e,t,r)=>{const o=e.querySelector(".popup__type");r?o.textContent=v[r]:e.removeChild(o)})(r,0,t.offer.type),((t,r,o)=>{const n=t.querySelector(".popup__features");o?(e(n),o.forEach((e=>{const t=`<li class="popup__feature popup__feature--${e}"></li>`;n.insertAdjacentHTML("beforeend",t)}))):t.removeChild(n)})(r,0,t.offer.features),((e,t,r,o)=>{const n=e.querySelector(".popup__text--capacity"),a=parseInt(r.toString().slice(-1)),s=parseInt(r.toString().slice(-2,-1)),c=parseInt(r.toString().slice(-2));let i=0;s&&(i=a+s);let l="комнат";1===a&&2!==i?l="комната":a>=2&&a<=4&&!(c>=10&&c<=20)&&(l="комнаты"),r&&o?n.textContent=`${r} ${l} для ${o} гостей`:r?n.textContent=`${r} ${l}`:o?n.textContent=`Для ${o} гостей`:e.removeChild(n)})(r,0,t.offer.rooms,t.offer.guests),((e,t,r,o)=>{const n=e.querySelector(".popup__text--time");r&&o?n.textContent=`Заезд после ${r}, выезд до ${o}`:r?n.textContent=`Заезд после ${r}`:o?n.textContent=`Выезд до ${o}`:e.removeChild(n)})(r,0,t.offer.checkin,t.offer.checkout),((t,r,o)=>{const n=t.querySelector(".popup__photos");o?(e(n),o.forEach((e=>{const t=`<img src="${e}" class="popup__photo" width="45" height="40" alt="Фотография жилья">`;n.insertAdjacentHTML("beforeend",t)}))):t.removeChild(n)})(r,0,t.offer.photos),r})(t),{keepInView:!0})}))},I=e=>{w.clearLayers();const t=e.filter(y);A(t)},$=["gif","jpg","jpeg","png"],T=document.querySelector(".ad-form-header__input"),j=document.querySelector(".ad-form-header__preview"),V=document.querySelector(".ad-form__input"),z=document.querySelector(".ad-form__photo"),D=(e,t)=>{e.addEventListener("change",(()=>{const r=e.files[0],o=r.name.toLowerCase();if($.some((e=>o.endsWith(e)))){const e=new FileReader;let o=t.querySelector(".ad-form-header__preview img");null===o&&(o=document.createElement("img"),o.setAttribute("width",40),o.setAttribute("height",40),t.appendChild(o)),e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(r)}}))};D(T,j),D(V,z);const F=()=>{j.querySelector(".ad-form-header__preview img").src="./img/muffin-grey.svg"},M=()=>{e(z)},N={bungalow:0,flat:1e3,house:5e3,palace:1e4},O=document.querySelector(".ad-form"),P=Array.from(O.children),R=O.querySelector("#title"),U=O.querySelector("#address"),G=O.querySelector("#type"),H=O.querySelector("#price"),W=O.querySelector("#timein"),X=O.querySelector("#timeout"),B=O.querySelector("#room_number"),J=O.querySelector("#capacity"),K=O.querySelector(".ad-form__reset"),Q=()=>{H.setAttribute("placeholder",N[G.value]),H.setAttribute("min",N[G.value]),H.setAttribute("max",1e6)},Y=()=>{100===parseInt(B.value)?(J.value=0,Array.from(J.options).forEach((e=>{e.disabled=parseInt(B.value)>parseInt(e.value)&&0!==parseInt(e.value)}))):(J.value=B.value,Array.from(J.options).forEach((e=>{e.disabled=parseInt(B.value)<parseInt(e.value)||0===parseInt(e.value)})))};var Z,ee;G.addEventListener("change",(()=>Q())),W.addEventListener("change",(()=>{X.value=W.value})),X.addEventListener("change",(()=>{W.value=X.value})),R.addEventListener("input",(()=>(e=>{const t=e.value.length;t<30?e.setCustomValidity("Ещё "+(30-t)+" симв."):t>100?e.setCustomValidity("Удалите лишние "+(t-100)+" симв."):e.setCustomValidity(""),e.reportValidity()})(R))),B.addEventListener("change",(()=>Y())),U.readOnly=!0,O.classList.add("ad-form--disabled"),P.forEach((e=>{e.disabled=!0})),Q(),Y(),O.addEventListener("submit",(e=>{var t,s,i;e.preventDefault(),t=()=>{a(r),O.reset(),c.reset(),M(),F(),x(),Q(),Y(),k()},s=()=>a(o,n),i=new FormData(e.target),fetch("https://22.javascript.pages.academy/keksobooking",{method:"POST",body:i}).then((e=>{e.ok?t():s()})).catch((()=>{s()}))})),K.addEventListener("click",(e=>{e.preventDefault(),c.reset(),O.reset(),M(),F(),x(),Q(),Y(),k()})),E.on("load",(()=>{O.classList.remove("ad-form--disabled"),P.forEach((e=>{e.disabled=!1})),x()})).setView({lat:S,lng:q},9),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(E),Z=e=>{var t;A(e),t=_.debounce((()=>I(e)),500),c.addEventListener("reset",(()=>{t()})),(e=>{c.addEventListener("change",(()=>{e()}))})(_.debounce((()=>I(e)),500))},ee=()=>(e=>{const t=document.createElement("div");t.style.zIndex=100,t.style.position="absolute",t.style.left=0,t.style.top=0,t.style.right=0,t.style.padding="10px 3px",t.style.fontSize="30px",t.style.textAlign="center",t.style.backgroundColor="red",t.textContent="Ошибка загрузки данных",document.body.append(t),setTimeout((()=>{t.remove()}),5e3)})(),fetch("https://22.javascript.pages.academy/keksobooking/data").then((e=>{if(e.ok)return e.json();ee()})).then((e=>{Z(e)})).catch((()=>{ee()}))})();
//# sourceMappingURL=main.bundle.js.map